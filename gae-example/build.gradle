defaultTasks 'clean', 'build'

apply plugin: 'java'
apply plugin: 'war'
apply plugin: 'eclipse'
apply plugin: 'maven'

sourceCompatibility = 1.5
targetCompatibility = 1.5

tangram_version = '0.6-SNAPSHOT'

servlet_spec = "2.5"
jsp_spec = "2.0"

// don't let gradle work with its defaults on my files...
webAppDirName = 'disabled'

repositories {

  mavenLocal()
    
  mavenRepo urls: [ "http://repo1.maven.org/maven2", "http://repository.jboss.org/maven2", "http://repository.springsource.com/maven/bundles/release", "http://repository.codehaus.org", "http://fornax.itemis.de/nexus/content/repositories/thirdparty" ]
  
}

compileJava.options.compilerArgs = ['-processor', 'org.datanucleus.enhancer.EnhancerProcessor'] 

jar.enabled = true 

configurations {
  libs 
  webapp
}

artifacts {
  archives war
  libs jar
}

dependencies {
  webapp "tangram:tangram-gae-webapp:$tangram_version"
  
  /*
  compile "org.apache.geronimo.specs:geronimo-jpa_3.0_spec:1.1.1"
  compile "javax.jdo:jdo2-api:2.3-eb"
  compile "org.datanucleus:datanucleus-core:1.1.5"
  compile "org.datanucleus:datanucleus-jpa:1.1.5"  
  compile "com.google.appengine.orm:datanucleus-appengine:1.0.8"
  */
  providedCompile "org.datanucleus:datanucleus-enhancer:1.1.4"
  
  providedCompile "javax.servlet:servlet-api:$servlet_spec"
  providedCompile "javax.servlet:jsp-api:$jsp_spec"
  compile "tangram:tangram-gae:$tangram_version"
}

jar.doFirst {
  // JDO Enhancing is not really done when we start this - sorry
  Thread.currentThread().sleep(5000)
}

war.doFirst {
  // Strange way of overwriting things
  if (configurations.webapp.dependencies.size() == 1) {
    archiveFileName = configurations.webapp.asPath
    idx = archiveFileName.indexOf(';')
    if (idx >= 0) {
      archiveFileName = archiveFileName.substring(0, idx)
    } // if
    println "unzipping $archiveFileName"
    ant.unzip(src: archiveFileName, dest: "$buildDir/target")  
  } // if
  
  // TODO: YUICompressor!
  copy {
    from 'src/main/webapp'
    into "$buildDir/target"
    include '**/**'
  }
  
  into ('') {
    from "$buildDir/target"
    exclude 'WEB-INF/lib/**'
  }
}

war {
  classpath = jar.outputs.files + configurations.runtime - configurations.providedRuntime
  excludes = [ "classes/**" ]
}

war.doLast {
  ant.unzip(src: war.archivePath, dest: "$buildDir/war")
}
